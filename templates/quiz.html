{% extends "base.html" %}

{% block content %}
<style>
/* --- STYLES SECTION --- */

.quiz-container {
    max-width: 48rem;
    margin: 0 auto;
    padding: 2rem;
    background-color: #fef3c7;
    border-radius: 1.5rem;
    border: 6px solid #fbbf24;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 
                0 10px 10px -5px rgba(0, 0, 0, 0.1);
    animation: slideIn 0.7s ease-out;
}

@keyframes slideIn {
    0% { transform: translateY(20px); opacity: 0; }
    100% { transform: translateY(0); opacity: 1; }
}

.quiz-title {
    text-align: center;
    font-size: 2.5rem;
    font-weight: 800;
    color: #10b981;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 4px dashed #fcd34d;
}

.question-card {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background-color: #ffffff;
    border-radius: 1rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 
                0 2px 4px -2px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s;
}
.question-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 
                0 4px 6px -4px rgba(0, 0, 0, 0.1);
}

.options {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.radio-label {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border-radius: 0.5rem;
    border: 2px solid #e5e7eb;
    background-color: #f9fafb;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.radio-label input[type="radio"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}

.radio-label span {
    font-size: 1.125rem;
    font-weight: 500;
    color: #374151;
    padding-left: 2rem;
    position: relative;
}

.radio-label span::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 1.25rem;
    height: 1.25rem;
    border-radius: 50%;
    border: 2px solid #a78bfa;
    background-color: #fff;
}

.radio-label:hover {
    border-color: #a78bfa;
    background-color: #f3e8ff;
}

.radio-label input[type="radio"]:checked + span {
    font-weight: 700;
    color: #5b21b6;
}

.radio-label input[type="radio"]:checked + span::after {
    content: '';
    position: absolute;
    left: 0.25rem;
    top: 50%;
    transform: translateY(-50%);
    width: 0.75rem;
    height: 0.75rem;
    border-radius: 50%;
    background-color: #8b5cf6;
    z-index: 10;
}

.submit-button {
    width: 100%;
    padding: 1rem 2.5rem;
    font-size: 1.5rem;
    font-weight: 700;
    border-radius: 0.75rem;
    color: white;
    background-color: #ec4899;
    transition: all 0.3s;
    box-shadow: 0 10px 15px -3px rgba(236, 72, 153, 0.5),
                0 4px 6px -4px rgba(236, 72, 153, 0.5);
    cursor: pointer;
}

.submit-button:hover {
    background-color: #db2777;
    transform: scale(1.02);
    box-shadow: 0 20px 25px -5px rgba(236, 72, 153, 0.5);
}

.submit-button:active {
    transform: scale(0.98);
}

/* Feedback Styles */
.correct-answer {
    margin-top: 0.5rem;
    font-weight: 700;
    color: #15803d;  /* green */
}

.incorrect-answer {
    margin-top: 0.5rem;
    font-weight: 700;
    color: #b91c1c;  /* red */
}

.user-choice {
    font-style: italic;
    margin-top: 0.25rem;
    color: #444;
}

.fact-text {
    margin-top: 0.5rem;
    font-size: 0.9rem;
    color: #6b7280;
}

.reward-message {
    background-color: #d1fae5;
    border: 2px solid #10b981;
    color: #065f46;
    font-weight: 700;
    text-align: center;
    padding: 1rem;
    margin-top: 2rem;
    border-radius: 1rem;
    font-size: 1.2rem;
}

/* NEW STYLES FOR STICKERS/EMOJIS (Visual Feedback) */
.feedback-container {
    text-align: center;
    margin-top: 1.5rem;
    padding: 1rem;
    border-radius: 10px;
    font-size: 3rem; /* Large emoji size */
}
.feedback-success {
    background-color: #ecfdf5; /* Light green background */
    border: 2px solid #10b981;
}
.feedback-fail {
    background-color: #fef2f2; /* Light red background */
    border: 2px solid #ef4444;
}

.home-button {
    display: inline-block;
    margin-top: 2rem;
    padding: 0.75rem;
    border-radius: 50%;
    background-color: #0ea5e9;
    border: 3px solid #38bdf8;
    transition: background-color 0.3s, transform 0.2s;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.home-button:hover {
    background-color: #0284c7;
    transform: scale(1.1);
}

.home-icon {
    width: 2.5rem;
    height: 2.5rem;
    fill: white;
}

.home-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 2rem;
    text-decoration: none;
}

.home-label {
    margin-top: 0.5rem;
    font-size: 1rem;
    color: #0ea5e9;
    font-weight: 600;
}
</style>

{# HIDDEN AUDIO ELEMENTS #}
<audio id="success-sound" src="{{ url_for('static', filename='success.mp3') }}" preload="auto"></audio>
<audio id="fail-sound" src="{{ url_for('static', filename='fail.mp3') }}" preload="auto"></audio>

<div class="quiz-container">
    <h2 class="quiz-title">{{ quiz.title }}</h2>

    {# FEEDBACK CONTAINER #}
    {% if show_results %}
        {% if total_incorrect == 0 %}
            <div id="quiz-feedback" class="feedback-container feedback-success">
                ü•≥ Perfect Score! You're a Water Saver Pro! üíßüåü
            </div>
        {% else %}
            <div id="quiz-feedback" class="feedback-container feedback-fail">
                üòî Almost! Don't worry, keep learning! üò≠
            </div>
        {% endif %}
    {% endif %}

    <form method="POST" id="quiz-form">
        {% for i, question in enumerate(quiz.questions) %}
            <div class="question-card">
                <p><strong>Q{{ i + 1 }}.</strong> {{ question.q }}</p>
                <div class="options">
                    {% for option in question.options %}
                        {# Determine if this option was selected by user #}
                        {% set user_selected = (submitted_answers and submitted_answers['q' ~ i] == option) %}
                        
                        {% if show_results %}
                            {% if option == question.answer %}
                                {# Correct answer option #}
                                <label class="radio-label" style="border-color: #15803d; background-color: #dcfce7; cursor: default;">
                                    <input type="radio" name="q{{ i }}" value="{{ option }}" {% if user_selected %}checked{% endif %} disabled>
                                    <span>{{ option }}</span>
                                </label>
                            {% elif user_selected %}
                                {# User selected wrong option #}
                                <label class="radio-label" style="border-color: #b91c1c; background-color: #fee2e2; cursor: default;">
                                    <input type="radio" name="q{{ i }}" value="{{ option }}" checked disabled>
                                    <span>{{ option }}</span>
                                </label>
                            {% else %}
                                {# Other options #}
                                <label class="radio-label" style="cursor: default;">
                                    <input type="radio" name="q{{ i }}" value="{{ option }}" disabled>
                                    <span>{{ option }}</span>
                                </label>
                            {% endif %}
                        {% else %}
                            {# Before submit - normal radio buttons #}
                            <label class="radio-label">
                                <input type="radio" name="q{{ i }}" value="{{ option }}" {% if user_selected %}checked{% endif %} required>
                                <span>{{ option }}</span>
                            </label>
                        {% endif %}
                    {% endfor %}
                </div>

                {% if show_results %}
                    {% set user_answer = submitted_answers['q' ~ i] %}
                    {% if user_answer == question.answer %}
                        <p class="correct-answer">‚úÖ Correct! Good job.</p>
                    {% else %}
                        <p class="incorrect-answer">‚ùå Incorrect.</p>
                        <p class="user-choice">Your answer: "{{ user_answer or 'No answer' }}"</p>
                        <p class="correct-answer">Correct answer: "{{ question.answer }}"</p>
                    {% endif %}
                    <p class="fact-text"><em>Fact:</em> {{ question.fact }}</p>
                {% endif %}
            </div>
        {% endfor %}

        {% if not show_results %}
            {# --- SUBMIT BUTTON WITH SOUND DELAY HANDLER --- #}
            <button type="submit" class="submit-button" onclick="return handleSubmission(event);">Submit Answers</button>
        {% else %}
            {% if reward %}
                <div class="reward-message">
                    üéâ You earned the reward: <strong>{{ reward }}</strong>
                </div>
            {% endif %}
            <div style="margin-top: 1rem; text-align: center;">
                <a href="{{ url_for('quiz_screen', category=quiz.next_route) }}" class="submit-button" style="text-decoration:none; display:inline-block;">
                    Next Quiz &raquo;
                </a>
            </div>
        {% endif %}
    </form>
</div>

{# --- JAVASCRIPT FOR SOUND ON SUBMIT --- #}
{% if not show_results %}
<script>
    function handleSubmission(event) {
        const form = document.getElementById('quiz-form');
        let totalCorrect = 0;
        
        // Embed the correct answers from the Python object into JavaScript
        const questions = [
            {% for question in quiz.questions %}
                { answer: "{{ question.answer | e }}" },
            {% endfor %}
        ];

        // 1. Prevent the default form submission (stops the page reload)
        event.preventDefault();

        // 2. Client-side check for which sound to play
        let allAnswered = true;
        for (let i = 0; i < questions.length; i++) {
            const radioName = 'q' + i;
            // Use form.elements to correctly retrieve the selected value from radio buttons
            const selectedElement = form.querySelector('input[name="' + radioName + '"]:checked');
            const selected = selectedElement ? selectedElement.value : null;
            
            if (!selected) {
                // If a question is unanswered, stop and let the native HTML validation handle it
                allAnswered = false;
                break; 
            }
            if (selected === questions[i].answer) {
                totalCorrect++;
            }
        }

        if (!allAnswered) {
             // If validation failed, let the form submit naturally to show required field messages
             form.submit();
             return;
        }

        // 3. Play the sound
        const totalIncorrect = questions.length - totalCorrect;
        const successSound = document.getElementById('success-sound');
        const failSound = document.getElementById('fail-sound');
        
        const soundToPlay = totalIncorrect === 0 ? successSound : failSound;

        if (soundToPlay) {
            // Attempt to play the sound
            soundToPlay.play().catch(error => {
                console.warn("Sound blocked/failed on click:", error);
            });
            
            // 4. Wait for the sound to play for a brief moment, then submit the form (page reload)
            // 750ms is usually a good delay for a quick sound
            setTimeout(() => {
                form.submit();
            }, 750); 
        } else {
            // If sound elements are not available, submit immediately
            form.submit();
        }
        
        // Returning false is unnecessary since we call event.preventDefault()
    }
</script>
{% endif %}

<div style="text-align: center;">
    <a href="{{ url_for('index_start') }}" class="home-wrapper" title="Back to Home">
        <div class="home-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="home-icon" viewBox="0 0 24 24">
                <path d="M12 2C9.243 6.278 6 10.182 6 13a6 6 0 0012 0c0-2.818-3.243-6.722-6-11z"/>
            </svg>
        </div>
        <div class="home-label">Home</div>
    </a>
</div>

{% endblock %}